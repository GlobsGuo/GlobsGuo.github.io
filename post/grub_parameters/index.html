<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>grub参数&#34;console=&#34; - Globs&#39; Catchall</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Globs Guo" /><meta name="description" content="本文主要分析Linux内核如何处理grub参数中的console=ttyS0,115200n8部分，中间还会穿插一些 include/linux/init.h 的内容。 grub参数中" />






<meta name="generator" content="Hugo 0.76.3 with theme even" />


<link rel="canonical" href="https://blog.globs.site/post/grub_parameters/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<link href="/dist/even.c2a46f00.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="grub参数&#34;console=&#34;" />
<meta property="og:description" content="本文主要分析Linux内核如何处理grub参数中的console=ttyS0,115200n8部分，中间还会穿插一些 include/linux/init.h 的内容。 grub参数中" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.globs.site/post/grub_parameters/" />
<meta property="article:published_time" content="2019-10-12T00:00:00+00:00" />
<meta property="article:modified_time" content="2019-10-12T00:00:00+00:00" />
<meta itemprop="name" content="grub参数&#34;console=&#34;">
<meta itemprop="description" content="本文主要分析Linux内核如何处理grub参数中的console=ttyS0,115200n8部分，中间还会穿插一些 include/linux/init.h 的内容。 grub参数中">
<meta itemprop="datePublished" content="2019-10-12T00:00:00+00:00" />
<meta itemprop="dateModified" content="2019-10-12T00:00:00+00:00" />
<meta itemprop="wordCount" content="6318">



<meta itemprop="keywords" content="kernel-sources,console,grub,kernel parameters,cmdline," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="grub参数&#34;console=&#34;"/>
<meta name="twitter:description" content="本文主要分析Linux内核如何处理grub参数中的console=ttyS0,115200n8部分，中间还会穿插一些 include/linux/init.h 的内容。 grub参数中"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Globs&#39; Catchall</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Globs&#39; Catchall</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">grub参数&#34;console=&#34;</h1>

      <div class="post-meta">
        <span class="post-time"> 2019-10-12 </span>
        
          <span class="more-meta"> 6318 words </span>
          <span class="more-meta"> 13 mins read </span>
        <span id="busuanzi_container_page_pv" class="more-meta"> <span id="busuanzi_value_page_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> times read </span>
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#41-console_initcall">4.1. console_initcall</a>
      <ul>
        <li><a href="#411-inbox-mode">4.1.1. inbox mode</a></li>
        <li><a href="#412-serial8250_console">4.1.2. serial8250_console</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>本文主要分析Linux内核如何处理grub参数中的console=ttyS0,115200n8部分，中间还会穿插一些  <em>include/linux/init.h</em>  的内容。</p>
<p>grub参数中的console=有多种形式，根据 <em>Documentation/kernel-parameters.txt</em> 文件，</p>
<blockquote>
<p>console=    [KNL] Output console device and options.</p>
<ul>
<li>tty&lt;n&gt;  Use the virtual console device &lt;n&gt;.</li>
<li>ttyS&lt;n&gt;[,options]</li>
<li>ttyUSB0[,options]<br>
Use the specified serial port.  The options are of  the form &ldquo;bbbbpnf&rdquo;, where &ldquo;bbbb&rdquo; is the baud rate, &ldquo;p&rdquo; is parity (&ldquo;n&rdquo;, &ldquo;o&rdquo;, or &ldquo;e&rdquo;), &ldquo;n&rdquo; is number of bits, and &ldquo;f&rdquo; is flow control (&ldquo;r&rdquo; for RTS or omit it).  Default is &ldquo;9600n8&rdquo;.</li>
<li>uart[8250],io,&lt;addr&gt;[,options]</li>
<li>uart[8250],mmio,&lt;addr&gt;[,options]<br>
Start an early, polled-mode console on the 8250/16550 UART at the specified I/O port or MMIO address, switching to the matching ttyS device later.  The options are the same as for ttyS, above.</li>
<li>hvc&lt;n&gt;  Use the hypervisor console device &lt;n&gt;.
This is for both Xen and PowerPC hypervisors.</li>
</ul>
</blockquote>
<p>本文主要分析参数值为ttyS&lt;n&gt;，uart[8250],io/mmio,&lt;addr&gt;[,options]的情况。</p>
<p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h1 id="1-cmdline的console参数">1. cmdline的&quot;console=&ldquo;参数</h1>
<p>内核启动过程中，把grub设置的cmdline保存在 <em>init/main.c</em>  的 <strong>boot_command_line</strong> 字符数组中，长度最大为256。<br>
<code>start_kernel</code>  函数在输出过 <strong>boot_command_line</strong> 信息后，会对其进行转化，分别调用 <code>parse_early_param</code>  -&gt; <code>parse_early_options</code>  -&gt; <code>parse_args(kernel/params.c)</code> -&gt; <code>do_early_param</code>  。其中， <code>parse_args</code>  函数调用 <code>parse_one</code>  完成具体的操作，各个参数如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"><span class="cm">/* @param = &#34;console&#34;
</span><span class="cm">   @val = &#34;ttyS0,115200n8&#34;或者&#34;uart[8250],io,&lt;addr&gt;[,option]&#34;
</span><span class="cm">   @doing = &#34;early options&#34;
</span><span class="cm">   @params = NULL
</span><span class="cm">   @num_params = 0
</span><span class="cm">   @min_level = 0
</span><span class="cm">   @max_level = 0
</span><span class="cm">   @unknown = do_early_param */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_one</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">param</span><span class="p">,</span>
             <span class="kt">char</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span>
             <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">doing</span><span class="p">,</span>
             <span class="k">const</span> <span class="k">struct</span> <span class="n">kernel_param</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
             <span class="kt">unsigned</span> <span class="n">num_params</span><span class="p">,</span>
             <span class="n">s16</span> <span class="n">min_level</span><span class="p">,</span>
             <span class="n">s16</span> <span class="n">max_level</span><span class="p">,</span>
             <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">handle_unknown</span><span class="p">)(</span><span class="kt">char</span> <span class="o">*</span><span class="n">param</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span>
                     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">doing</span><span class="p">))</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

    <span class="cm">/* Find parameter */</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_params</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">parameq</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">level</span> <span class="o">&lt;</span> <span class="n">min_level</span>
                <span class="o">||</span> <span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">level</span> <span class="o">&gt;</span> <span class="n">max_level</span><span class="p">)</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
            <span class="cm">/* No one handled NULL, so do it here. */</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">val</span> <span class="o">&amp;&amp;</span>
                <span class="o">!</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">KERNEL_PARAM_FL_NOARG</span><span class="p">))</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
            <span class="n">pr_debug</span><span class="p">(</span><span class="s">&#34;handling %s with %p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span>
                <span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set</span><span class="p">);</span>
            <span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">param_lock</span><span class="p">);</span>
            <span class="n">err</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
            <span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">param_lock</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">handle_unknown</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">pr_debug</span><span class="p">(</span><span class="s">&#34;doing %s: %s=&#39;%s&#39;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">doing</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">handle_unknown</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">doing</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">pr_debug</span><span class="p">(</span><span class="s">&#34;Unknown argument &#39;%s&#39;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">param</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>最终，<code>handle_unknown(param, val, doing)</code> -&gt; <code>do_early_param(param, val, doing)</code>，</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"><span class="cm">/* @param = &#34;console&#34;
</span><span class="cm">   @val = &#34;uart[8250],io,&lt;addr&gt;[,option]&#34;
</span><span class="cm">   @unused = &#34;early options&#34; */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">do_early_param</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">param</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="k">struct</span> <span class="n">obs_kernel_param</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
    <span class="cm">/* __setup_start声明在init/main.c文件中，通过lds文件链接到名为
</span><span class="cm">       .init.setup 的段中，这个段通过include/linux/init.h中的宏
</span><span class="cm">       __setup定义.
</span><span class="cm">       因此，这里会遍历所有通过__setup宏定义的函数，选择设置了early=1
</span><span class="cm">       的obs_kernel_param对象，并且str=&#34;earlycon&#34;的函数，
</span><span class="cm">       执行其setup_func */</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">__setup_start</span><span class="p">;</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="n">__setup_end</span><span class="p">;</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">early</span> <span class="o">&amp;&amp;</span> <span class="n">parameq</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">))</span> <span class="o">||</span>
            <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="s">&#34;console&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
             <span class="n">strcmp</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">,</span> <span class="s">&#34;earlycon&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">setup_func</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">pr_warn</span><span class="p">(</span><span class="s">&#34;Malformed early option &#39;%s&#39;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">param</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="cm">/* We accept everything at this stage. */</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>设置了early标志的 <strong>struct obs_kernel_param</strong> 对象通过 <strong>early_param</strong> 宏定义，在  <em>include/linux/init.h</em>  中：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"> <span class="cp">#define early_param(str, fn)
</span><span class="cp"></span>    <span class="n">__setup_param</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="cp">#define __setup_param(str, unique_id, fn, early)
</span><span class="cp"></span>    <span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__setup_str_</span><span class="err">##</span><span class="n">unique_id</span><span class="p">[]</span> <span class="n">__initconst</span>
        <span class="n">__aligned</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">str</span><span class="p">;</span>
    <span class="k">static</span> <span class="k">struct</span> <span class="n">obs_kernel_param</span> <span class="n">__setup_</span><span class="err">##</span><span class="n">unique_id</span>
        <span class="n">__used</span> <span class="n">__section</span><span class="p">(.</span><span class="n">init</span><span class="p">.</span><span class="n">setup</span><span class="p">)</span>
        <span class="n">__attribute__</span><span class="p">((</span><span class="n">aligned</span><span class="p">((</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">)))))</span>
        <span class="o">=</span> <span class="p">{</span> <span class="n">__setup_str_</span><span class="err">##</span><span class="n">unique_id</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">early</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="2-consoleuart8250iommioaddroptions">2. console=uart[8250],io/mmio,&lt;addr&gt;[,options]</h1>
<p>这种情况下，<code>do_early_param(param, val, doing)</code> 的参数<strong>param=&ldquo;console&rdquo;</strong> ， <strong>&ldquo;val=uart[8250],io/mmio,&lt;addr&gt;[,options]&quot;</strong> 。</p>
<p>根据定义在 <em>include/linux/serial_core.h</em>  中的</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"><span class="cp">#define EARLYCON_DECLARE(name, func)
</span><span class="cp"></span><span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="n">name</span><span class="err">##</span><span class="n">_setup_earlycon</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">setup_earlycon</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">__stringify</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="n">func</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">early_param</span><span class="p">(</span><span class="s">&#34;earlycon&#34;</span><span class="p">,</span> <span class="n">name</span><span class="err">##</span><span class="n">_setup_earlycon</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>和 <em>drivers/tty/serial/8250/8250_early.c</em>  中的 <code>EARLYCON_DECLARE(uart8250, early_serial8250_setup);</code> 和 <code>EARLYCON_DECLARE(uart, early_serial8250_setup);</code> 即</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"><span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="n">uart</span><span class="p">[</span><span class="mi">8250</span><span class="p">]</span><span class="n">_setup_earlycon</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">setup_earlycon</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">__stringify</span><span class="p">(</span><span class="n">uart</span><span class="p">[</span><span class="mi">8250</span><span class="p">]),</span> <span class="n">early_serial8250_setup</span><span class="p">);</span>
 <span class="p">}</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__setup_str_uart</span><span class="p">[</span><span class="mi">8250</span><span class="p">]</span><span class="n">_setup_earlycon</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&#34;earlycon&#34;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">obs_kernel_param</span> <span class="n">__setup_uart</span><span class="p">[</span><span class="mi">8250</span><span class="p">]</span><span class="n">_setup_earlycon</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">.</span><span class="n">str</span> <span class="o">=</span> <span class="s">&#34;earlycon&#34;</span><span class="p">,</span>
        <span class="p">.</span><span class="n">setup_func</span> <span class="o">=</span> <span class="n">uart</span><span class="p">[</span><span class="mi">8250</span><span class="p">]</span><span class="n">_setup_earlycon</span><span class="p">,</span>
        <span class="p">.</span><span class="n">early</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div><p><code>do_early_param</code>  函数中的 <code>p-&gt;setup_func(val)</code> 即 <code>uart[8250]_setup_earlycon(val)</code> -&gt; <code>setup_earlycon(&quot;uart[8250],io/mmio,&lt;addr&gt;[,options]&quot;, &quot;uart8250&quot;, early_serial8250_setup)</code> ，定义在 <em>drivers/tty/serial/earlycon.c</em>  。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"><span class="cm">/* @buf = &#34;uart[8250],io/mmio,&lt;addr&gt;[,options]&#34;
</span><span class="cm">   @match = &#34;uart8250&#34;
</span><span class="cm">   @setup = early_8250_setup */</span>
<span class="kt">int</span> <span class="n">__init</span> <span class="nf">setup_earlycon</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">match</span><span class="p">,</span>
              <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">setup</span><span class="p">)(</span><span class="k">struct</span> <span class="n">earlycon_device</span> <span class="o">*</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">))</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
    <span class="n">size_t</span> <span class="n">len</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">early_console_dev</span><span class="p">.</span><span class="n">port</span><span class="p">;</span>
    <span class="c1">// if条件不满足，不会返回
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span> <span class="o">||</span> <span class="o">!</span><span class="n">match</span> <span class="o">||</span> <span class="o">!</span><span class="n">setup</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">match</span><span class="p">);</span>
    <span class="c1">// if条件不满足，不会返回
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">match</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;,&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="c1">//buf指向io/mmio的位置
</span><span class="c1"></span>    <span class="n">buf</span> <span class="o">+=</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="c1">//将buf中的参数信息保存在early_console_dev对象中
</span><span class="c1"></span>    <span class="n">err</span> <span class="o">=</span> <span class="n">parse_options</span><span class="p">(</span><span class="o">&amp;</span><span class="n">early_console_dev</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
    <span class="cm">/* On parsing error, pass the options buf to the setup function */</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">mapbase</span><span class="p">)</span>
        <span class="n">port</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">=</span> <span class="n">earlycon_map</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">mapbase</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>

    <span class="n">early_console_dev</span><span class="p">.</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">early_console_dev</span><span class="p">;</span>
    <span class="cm">/* setup -&gt; early_serial8250_setup -&gt; init_port */</span>
    <span class="n">err</span> <span class="o">=</span> <span class="n">setup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">early_console_dev</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
    <span class="c1">// set in early_serial8250_setup, is early_serialt8250_write
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">early_console_dev</span><span class="p">.</span><span class="n">con</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
    <span class="c1">//控制台信息初始化完成后，调用register_console注册控制台
</span><span class="c1"></span>    <span class="n">register_console</span><span class="p">(</span><span class="n">early_console_dev</span><span class="p">.</span><span class="n">con</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="3-register_console">3. register_console</h1>
<p>根据代码中 <code>register_console</code>  的注释，</p>
<blockquote>
<p>The console driver calls this routine during kernel initialization to register the console printing procedure with printk() and to print any messages that were printed by the kernel before the console driver was initialized.</p>
</blockquote>
<p>控制台驱动在内核初始化时调用这个函数将控制台输出程序注册到 <code>printk</code>  函数，在控制台驱动初始化前打印内核的输出信息。</p>
<blockquote>
<p>This can happen pretty early during the boot process (because of early_printk) - sometimes before setup_arch() completes - be careful of what kernel features are used - they may not be initialised yet.</p>
</blockquote>
<p>内核可能在启动过程的很早阶段（This指的是）输出信息（由于 <code>early_printk</code>  ），有时会在 <code>setup_arch</code>  函数完成之前，注意使用的内核features，这些features可能还没有初始化。</p>
<blockquote>
<p>There are two types of consoles - bootconsoles (early_printk) and &ldquo;real&rdquo; consoles (everything which is not a bootconsole) which are handled differently.</p>
<ul>
<li>Any number of bootconsoles can be registered at any time.</li>
<li>As soon as a &ldquo;real&rdquo; console is registered, all bootconsoles will be unregistered automatically.</li>
<li>Once a &ldquo;real&rdquo; console is registered, any attempt to register a bootconsoles will be rejected</li>
</ul>
</blockquote>
<p>控制台分为两大类：bootconsoles( <code>early_printk</code>  )和真正的控制台（除了bootconsole之外的控制台），按照不同的方式处理：</p>
<ul>
<li>可以在任何时刻注册任意数量的bootconsoles</li>
<li>所有的bootconsoles都会在注册真正的控制台的同时被自动注销</li>
<li>一旦注册了真正的控制台，任何注册bootconsoles的尝试都会被拒绝</li>
</ul>
<p><code>struct console *console_drivers</code> 包含所有的已经注册的控制台驱动，通过 <code>struct console</code> 内的next指针索引。</p>
<p>针对 <strong>early_console_dev</strong> ，</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"><span class="k">struct</span> <span class="n">earlycon_device</span> <span class="n">early_console_dev</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">.</span><span class="n">con</span> <span class="o">=</span> <span class="n">early_con</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;uart&#34;</span><span class="p">,</span>
        <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">CON_PRINTBUFFER</span> <span class="o">|</span> <span class="n">CON_BOOT</span><span class="p">,</span>
        <span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">};</span>
<span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div><p>执行 <code>register_console</code>  时，假设 <strong>console_drivers</strong> 中没有已经注册的驱动，</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"><span class="kt">void</span> <span class="nf">register_console</span><span class="p">(</span><span class="k">struct</span> <span class="n">console</span> <span class="o">*</span><span class="n">newcon</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">console</span> <span class="o">*</span><span class="n">bcon</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">console_cmdline</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
    <span class="p">...</span>
    <span class="c1">//if条件满足，但是prefered和selected都是-1
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">preferred_console</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">bcon</span> <span class="o">||</span> <span class="o">!</span><span class="n">console_drivers</span><span class="p">)</span>
        <span class="n">preferred_console</span> <span class="o">=</span> <span class="n">selected_console</span><span class="p">;</span>
    <span class="c1">//未定义，不会执行
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">newcon</span><span class="o">-&gt;</span><span class="n">early_setup</span><span class="p">)</span>
        <span class="n">newcon</span><span class="o">-&gt;</span><span class="n">early_setup</span><span class="p">();</span>

    <span class="cm">/*
</span><span class="cm">     *  See if we want to use this console driver. If we
</span><span class="cm">     *  didn&#39;t select a console we take the first one
</span><span class="cm">     *  that registers here.
</span><span class="cm">     */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">preferred_console</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">//true
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">newcon</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1">//true
</span><span class="c1"></span>            <span class="n">newcon</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">newcon</span><span class="o">-&gt;</span><span class="n">setup</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>   <span class="c1">//true
</span><span class="c1"></span>            <span class="n">newcon</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">(</span><span class="n">newcon</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">newcon</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CON_ENABLED</span><span class="p">;</span>  <span class="c1">//set
</span><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="n">newcon</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>    <span class="c1">//false
</span><span class="c1"></span>                <span class="n">newcon</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CON_CONSDEV</span><span class="p">;</span>
                <span class="n">preferred_console</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="cm">/* 现在newcon = {
</span><span class="cm">               .name = &#34;uart&#34;,
</span><span class="cm">               .flags = CON_PRINTBUFFER | CON_BOOT | CON_ENABLED,,
</span><span class="cm">               .index = 0,
</span><span class="cm">          }; */</span>
      <span class="cm">/*
</span><span class="cm">     *  See if this console matches one we selected on
</span><span class="cm">     *  the command line.
</span><span class="cm">     */</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">console_cmdline</span><span class="p">;</span>
         <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_CMDLINECONSOLES</span> <span class="o">&amp;&amp;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
         <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">c</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">newcon</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">continue</span><span class="p">;</span>   <span class="c1">//控制台名称不匹配
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">newcon</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
            <span class="n">newcon</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">!=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">)</span>
            <span class="k">continue</span><span class="p">;</span>   <span class="c1">//控制台名称匹配，设备index不匹配
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">newcon</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>   <span class="c1">//false
</span><span class="c1"></span>            <span class="n">newcon</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">_braille_register_console</span><span class="p">(</span><span class="n">newcon</span><span class="p">,</span> <span class="n">c</span><span class="p">))</span>   <span class="c1">//false
</span><span class="c1"></span>            <span class="k">return</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">newcon</span><span class="o">-&gt;</span><span class="n">setup</span> <span class="o">&amp;&amp;</span>
            <span class="n">newcon</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">(</span><span class="n">newcon</span><span class="p">,</span> <span class="n">console_cmdline</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">options</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">break</span><span class="p">;</span>      <span class="c1">//false
</span><span class="c1"></span>        <span class="cm">/* 根据命令行的控制台信息更新newcon参数 */</span>
        <span class="n">newcon</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CON_ENABLED</span><span class="p">;</span>
        <span class="n">newcon</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">selected_console</span><span class="p">)</span> <span class="p">{</span>    <span class="c1">//false
</span><span class="c1"></span>            <span class="n">newcon</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CON_CONSDEV</span><span class="p">;</span>
            <span class="n">preferred_console</span> <span class="o">=</span> <span class="n">selected_console</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">...</span>
     <span class="cm">/*
</span><span class="cm">     *  Put this console in the list - keep the
</span><span class="cm">     *  preferred driver at the head of the list.
</span><span class="cm">     */</span>
    <span class="n">console_lock</span><span class="p">();</span>
    <span class="c1">//console_drivers = NULL
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">((</span><span class="n">newcon</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CON_CONSDEV</span><span class="p">)</span> <span class="o">||</span> <span class="n">console_drivers</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">newcon</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">console_drivers</span><span class="p">;</span>
        <span class="n">console_drivers</span> <span class="o">=</span> <span class="n">newcon</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">newcon</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>   <span class="c1">//false
</span><span class="c1"></span>            <span class="n">newcon</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CON_CONSDEV</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">newcon</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">console_drivers</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
        <span class="n">console_drivers</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">newcon</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">newcon</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CON_PRINTBUFFER</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">//true
</span><span class="c1"></span>        <span class="cm">/*
</span><span class="cm">         * console_unlock(); will print out the buffered messages
</span><span class="cm">         * for us. */</span>
        <span class="n">raw_spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">logbuf_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
        <span class="n">console_seq</span> <span class="o">=</span> <span class="n">syslog_seq</span><span class="p">;</span>
        <span class="n">console_idx</span> <span class="o">=</span> <span class="n">syslog_idx</span><span class="p">;</span>
        <span class="n">console_prev</span> <span class="o">=</span> <span class="n">syslog_prev</span><span class="p">;</span>
        <span class="n">raw_spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">logbuf_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
        <span class="cm">/*
</span><span class="cm">         * We&#39;re about to replay the log buffer.  Only do this to the
</span><span class="cm">         * just-registered console to avoid excessive message spam to
</span><span class="cm">         * the already-registered consoles. */</span>
        <span class="n">exclusive_console</span> <span class="o">=</span> <span class="n">newcon</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">console_unlock</span><span class="p">();</span>
    <span class="n">console_sysfs_notify</span><span class="p">();</span>
    <span class="p">...</span>
    <span class="c1">//这是一个boot console
</span><span class="c1"></span>    <span class="n">pr_info</span><span class="p">(</span><span class="s">&#34;%sconsole [%s%d] enabled</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
        <span class="p">(</span><span class="n">newcon</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CON_BOOT</span><span class="p">)</span> <span class="o">?</span> <span class="s">&#34;boot&#34;</span> <span class="o">:</span> <span class="s">&#34;&#34;</span> <span class="p">,</span>
        <span class="n">newcon</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">newcon</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>

<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>至此，通过 <strong>console=uart[8250],io/mmio,&lt;addr&gt;[,options]</strong> 设置的控制台已经注册到内核中， 可以正常工作。</p>
<p>正如内核中的注释所说：</p>
<blockquote>
<p>Start an early, polled-mode console on the 8250/16550 UART at the specified I/O port or MMIO address, switching to the matching ttyS device later. The options are the same as for ttyS, above.</p>
</blockquote>
<p>这种类型的控制台是轮询模式的，之后会切换到对应的 <strong>ttyS&lt;n&gt;</strong> 设备，并且采用相同的参数信息。发生在 <code>serial8250_console_init</code>  执行时调用 <code>register_console</code>  ，进而调用 <code>serial8250_conosle_early_setup</code>  -&gt; <code>serial8250_find_port_for_earlycon</code>  ，下一部分内容中 会有详细介绍。</p>
<h1 id="4-consolettysnoptions">4. console=ttyS&lt;n&gt;[,options]</h1>
<p>这种类型的控制台并不通过 <code>early_param</code>  宏定义，没有设置 <strong>early</strong> 标志，因此不会在 <code>do_early_param</code>  函数中调用。</p>
<h2 id="41-console_initcall">4.1. console_initcall</h2>
<p><code>console_initcall</code>  宏有两种定义，一种是 <strong>MODULE</strong> 下的定义：<code>#define console_initcall(fn) module_init(fn)</code>， <code>module_init</code>  的定义为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"><span class="cp">#define module_init(initfn)
</span><span class="cp"></span>    <span class="k">static</span> <span class="kr">inline</span> <span class="n">initcall_t</span> <span class="nf">__inittest</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
    <span class="p">{</span> <span class="k">return</span> <span class="n">initfn</span><span class="p">;</span> <span class="p">}</span>  
    <span class="kt">int</span> <span class="nf">init_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">alias</span><span class="p">(</span><span class="err">#</span><span class="n">initfn</span><span class="p">)));</span>
</code></pre></td></tr></table>
</div>
</div><p><code>initcall_t</code>  即<code>typedef int (*initcall_t)(void);</code> ，于是，<code>console_initcall(serial8250_console_init);</code> 就变成了</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"><span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">_inittest</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">serial8250_console_init</span><span class="p">;</span> <span class="p">}</span>
<span class="kt">int</span> <span class="nf">init_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">alias</span><span class="p">(</span><span class="s">&#34;serial8250_console_init&#34;</span><span class="p">));</span>
</code></pre></td></tr></table>
</div>
</div><p><code>__attribute__((alias(&quot;serial8250_console_init&quot;))</code> 这个GCC函数属性alias告诉编译器，把 <code>serial8250_console_init</code>  用 <code>init_module</code>  代替。</p>
<h3 id="411-inbox-mode">4.1.1. inbox mode</h3>
<p>还有一种是inbox mode（make menuconfig时直接选择某个模块，而不是M），这种情况下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"><span class="cp">#define console_initcall(fn)
</span><span class="cp"></span>    <span class="k">static</span> <span class="n">initcall_t</span> <span class="n">__initcall_</span><span class="err">##</span><span class="n">fn</span>
    <span class="n">__used</span> <span class="n">__section</span><span class="p">(.</span><span class="n">con_initcall</span><span class="p">.</span><span class="n">init</span><span class="p">)</span> <span class="o">=</span> <span class="n">fn</span>
</code></pre></td></tr></table>
</div>
</div><p><code>console_initcall(serial8250_console_init);</code> (  <em>drivers/tty/serial/8250/8250_core.c</em>  )即</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"><span class="k">static</span> <span class="kt">int</span> <span class="n">__initcall_serial8250_console_init</span> <span class="n">__used</span> <span class="nf">__section</span><span class="p">(.</span><span class="n">con_initcall</span><span class="p">.</span><span class="n">init</span><span class="p">)</span> <span class="o">=</span> <span class="n">serial8250_console_init</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p>定义了一个名为 <code>__initcall_serial8250_console_init</code>  的函数，具有used属性（code must be emitted even if it appears that function is not referenced），放在名为 <strong>.con_initcall.init</strong> 的段中。</p>
<p>根据lds的内容，这个 <strong>.con_initcall.init</strong> 段会被链接到  <em>include/linux/init.h</em>  的 <code>__con_initcall_start</code>  指向的地址（也可以查看内核源码目录下的System.map文件，搜索名为  <strong>__initcall_serial8250_console_init</strong>  函数），然后在  <em>drivers/tty/tty_io.c</em>  中的 <code>console_init</code>  函数调用。</p>
<p>完整的函数调用路径为： <code>start_kernel</code>  (  <em>init/main.c</em>  )  -&gt; <code>console_init</code>  -&gt; <code>__initcall_serial8250_console_init</code>  -&gt; <code>serialt8250_console_init</code>  。</p>
<h3 id="412-serial8250_console">4.1.2. serial8250_console</h3>
<p><code>serial8250_console_init</code>  函数首先调用 <code>serial8250_isa_init_ports</code>  根据  <em>arch/x86/include/asm/serial.h</em>  中的 <strong>SERIAL_PORT_DFNS</strong> 信息对 <strong>struct uart_8250_port serial8250_ports</strong>  结构体对象进行初始化，然后再调用  <em>kernel/printk/printk.c</em>  -&gt; <code>register_console(&amp;serial8250_console)</code> 注册8250控制台到内核。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"><span class="k">static</span> <span class="k">struct</span> <span class="n">console</span> <span class="n">serial8250_console</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">.</span><span class="n">name</span>       <span class="o">=</span> <span class="s">&#34;ttyS&#34;</span><span class="p">,</span>
    <span class="p">.</span><span class="n">write</span>      <span class="o">=</span> <span class="n">serial8250_console_write</span><span class="p">,</span>
    <span class="p">.</span><span class="n">device</span>     <span class="o">=</span> <span class="n">uart_console_device</span><span class="p">,</span>
    <span class="p">.</span><span class="n">setup</span>      <span class="o">=</span> <span class="n">serial8250_console_setup</span><span class="p">,</span>
    <span class="p">.</span><span class="n">early_setup</span>    <span class="o">=</span> <span class="n">serial8250_console_early_setup</span><span class="p">,</span>
    <span class="p">.</span><span class="n">flags</span>      <span class="o">=</span> <span class="n">CON_PRINTBUFFER</span> <span class="o">|</span> <span class="n">CON_ANYTIME</span><span class="p">,</span>
    <span class="p">.</span><span class="n">index</span>      <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">.</span><span class="n">data</span>       <span class="o">=</span> <span class="o">&amp;</span><span class="n">serial8250_reg</span><span class="p">,</span>
<span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div><p>由于 <strong>serial8250_console</strong> 之前没有注册过，也不具有 <strong>CON_BOOT</strong> 标志，因此会直接执行</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"><span class="kt">void</span> <span class="nf">register_console</span><span class="p">(</span><span class="k">struct</span> <span class="n">console</span> <span class="o">*</span><span class="n">newcon</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">console</span> <span class="o">*</span><span class="n">bcon</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">console_cmdline</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
    <span class="p">...</span>
    <span class="cm">/* 如果有console=uart参数，此时console_drivers已经包含uart类型的
</span><span class="cm">       控制台，而且是一个bootconsole，下列两个if条件都会满足 */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">console_drivers</span> <span class="o">&amp;&amp;</span> <span class="n">console_drivers</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CON_BOOT</span><span class="p">)</span>
        <span class="n">bcon</span> <span class="o">=</span> <span class="n">console_drivers</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">preferred_console</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">bcon</span> <span class="o">||</span> <span class="o">!</span><span class="n">console_drivers</span><span class="p">)</span>
        <span class="n">preferred_console</span> <span class="o">=</span> <span class="n">selected_console</span><span class="p">;</span>
    <span class="c1">// serial8250_console_early_setup
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">newcon</span><span class="o">-&gt;</span><span class="n">early_setup</span><span class="p">)</span>
        <span class="n">newcon</span><span class="o">-&gt;</span><span class="n">early_setup</span><span class="p">();</span>
</code></pre></td></tr></table>
</div>
</div><p><code>newcon-&gt;early_setup()</code> -&gt; <code>serial8250_console_early_setup</code>  -&gt; <code>serial8250_find_port_for_earlycon</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"><span class="kt">int</span> <span class="nf">serial8250_find_port_for_earlycon</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/* 如果设置了uart控制台，这里的early_device就是
</span><span class="cm">       struct earlycon_device early_console_dev，
</span><span class="cm">      在函数early_serial8250_serup里设置，否则就是NULL */</span>
    <span class="k">struct</span> <span class="n">earlycon_device</span> <span class="o">*</span><span class="n">device</span> <span class="o">=</span> <span class="n">early_device</span><span class="p">;</span>

    <span class="cm">/* 如果early_device为NULL，这里port就为NULL，
</span><span class="cm">       在之后的代码语句会直接返回-ENODEV, 否则就根据
</span><span class="cm">       early_device寻找用于控制台的串口信息 */</span>
    <span class="k">struct</span> <span class="n">uart_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">device</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="nl">port</span> <span class="p">:</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">line</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">))</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

    <span class="cm">/* 查找和serial8250_ports中保存的串口信息相匹配的
</span><span class="cm">       串口line，匹配包括串口的iotype和io地址 */</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">serial8250_find_port</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">line</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
    <span class="cm">/* 如果console_cmdline数组中已有匹配的uart8250控制台
</span><span class="cm">       信息，将其更新为ttySn信息 */</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">update_console_cmdline</span><span class="p">(</span><span class="s">&#34;uart&#34;</span><span class="p">,</span> <span class="mi">8250</span><span class="p">,</span>
                 <span class="s">&#34;ttyS&#34;</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">);</span>
    <span class="cm">/* 如果console_cmdline数组中已有匹配的uart控制台信息
</span><span class="cm">       将其更新为ttySn信息 */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">update_console_cmdline</span><span class="p">(</span><span class="s">&#34;uart&#34;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                     <span class="s">&#34;ttyS&#34;</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">update_console_cmdline</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name_new</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx_new</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">options</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">console_cmdline</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="cm">/* console_cmdline是struct console_cmdline对象数组，
</span><span class="cm">       保存系统中所有的根据cmdline信息构建的控制台信息，
</span><span class="cm">       即grub参数console=，最多为8 */</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">console_cmdline</span><span class="p">;</span>
         <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_CMDLINECONSOLES</span> <span class="o">&amp;&amp;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
         <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">c</span><span class="o">++</span><span class="p">)</span>
        <span class="cm">/* 如果name和index匹配，就用新的name替换旧的name，
</span><span class="cm">           并设置option，更新index信息，返回其在console_cmdline
</span><span class="cm">           的数组下标。 */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">==</span> <span class="n">idx</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">strlcpy</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">name_new</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
            <span class="n">c</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">c</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">=</span> <span class="n">options</span><span class="p">;</span>
            <span class="n">c</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">idx_new</span><span class="p">;</span>
            <span class="k">return</span> <span class="n">i</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="cm">/* not found */</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>newcon-&gt;early_setup()</code> 返回之后， <code>register_console</code>  函数会继续执行，</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C">    <span class="k">if</span> <span class="p">(</span><span class="n">preferred_console</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>    <span class="c1">//假设为true
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">newcon</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1">//true
</span><span class="c1"></span>            <span class="n">newcon</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">newcon</span><span class="o">-&gt;</span><span class="n">setup</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>    <span class="c1">//false
</span><span class="c1"></span>            <span class="cm">/* serial8250_console_setup
</span><span class="cm">               newcon = serial8250_console */</span>
            <span class="n">newcon</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">(</span><span class="n">newcon</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="c1">//true
</span><span class="c1"></span>            <span class="n">newcon</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CON_ENABLED</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">newcon</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span> <span class="c1">//true
</span><span class="c1"></span>                <span class="n">newcon</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CON_CONSDEV</span><span class="p">;</span>
                <span class="n">preferred_console</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>serial8250_console_setup</code>  会调用 <code>uart_parse_options</code>  和 <code>uart_set_options</code>  函数先把传入的串口参数信息转化，然后设置到串口信息中。这里，由于串口的参数为NULL， <code>uart_set_options</code>  函数会直接采用默认值9600n8，无flow control设置串口信息。</p>
<p>如果newcon和通过cmdline选择的控制台匹配， <code>register_console</code>  根据cmdline的控制台信息设置newcon：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C">    <span class="cm">/* 如果console_cmdline中包含和newcon匹配的控制台，
</span><span class="cm">       用控制台的参数信息重新配置newcon
</span><span class="cm">       但是这样有一个问题，如果上面的代码preferred&lt;0成立
</span><span class="cm">       会设置newcon-&gt;index=0；
</span><span class="cm">       假设console=ttyS1，则console_cmdline的index不会和
</span><span class="cm">       newcon-&gt;index相等，就无法根据console_cmdline的信息
</span><span class="cm">       设置控制台参数 */</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">console_cmdline</span><span class="p">;</span>
         <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_CMDLINECONSOLES</span> <span class="o">&amp;&amp;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
         <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">c</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">newcon</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">newcon</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
            <span class="n">newcon</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">!=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">)</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">newcon</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">newcon</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">_braille_register_console</span><span class="p">(</span><span class="n">newcon</span><span class="p">,</span> <span class="n">c</span><span class="p">))</span>
            <span class="k">return</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">newcon</span><span class="o">-&gt;</span><span class="n">setup</span> <span class="o">&amp;&amp;</span>
            <span class="n">newcon</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">(</span><span class="n">newcon</span><span class="p">,</span> <span class="n">console_cmdline</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">options</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="n">newcon</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CON_ENABLED</span><span class="p">;</span>
        <span class="n">newcon</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">selected_console</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">newcon</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CON_CONSDEV</span><span class="p">;</span>
            <span class="n">preferred_console</span> <span class="o">=</span> <span class="n">selected_console</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">...</span>
    <span class="c1">//如果newcon是非bootconsole，释放所有已经注册的bootconsoles
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">bcon</span> <span class="o">&amp;&amp;</span>
        <span class="p">((</span><span class="n">newcon</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">CON_CONSDEV</span> <span class="o">|</span> <span class="n">CON_BOOT</span><span class="p">))</span> <span class="o">==</span> <span class="n">CON_CONSDEV</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
        <span class="o">!</span><span class="n">keep_bootcon</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* We need to iterate through all boot consoles, to make
</span><span class="cm">         * sure we print everything out, before we unregister them.
</span><span class="cm">         */</span>
        <span class="n">for_each_console</span><span class="p">(</span><span class="n">bcon</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">bcon</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CON_BOOT</span><span class="p">)</span>
                <span class="n">unregister_console</span><span class="p">(</span><span class="n">bcon</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="5-preferred_console">5. preferred_console</h1>
<p>下面，追踪一下变量 <strong>selected_console</strong> 和 <strong>preferred_console</strong> ，这两个都是定义在  <em>kernel/printk/printk.c</em>  中的静态变量。</p>
<p><strong>preferred_console</strong> 只有在函数 <code>register_console</code>  中才会修改，而且赋值语句的右值都是 <strong>selected_console</strong> ； <strong>selected_console</strong> 的赋值都在 <code>__add_preferred_console</code>  函数。</p>
<p>函数的逆调用路径为： <code>__add_preferred_console</code>  &lt;- <code>console_setup</code>  &lt;- <code>obsolete_checksetup</code>  （ <em>init/main.c</em>  ) &lt;- <code>unknown_bootoption</code>  &lt;- <code>parse_args</code>  &lt;- <code>start_kernel</code>  。</p>
<p>先看 <code>start_kernel</code>  函数：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C">    <span class="p">...</span>
    <span class="n">pr_notice</span><span class="p">(</span><span class="s">&#34;Kernel command line: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">boot_command_line</span><span class="p">);</span>
    <span class="c1">// console=uart 在这个函数处理，创建earlycon
</span><span class="c1"></span>    <span class="n">parse_early_param</span><span class="p">();</span>
    <span class="c1">// console=ttyS&lt;n&gt; 在这个函数处理，添加preferred console？
</span><span class="c1"></span>    <span class="n">after_dashes</span> <span class="o">=</span> <span class="n">parse_args</span><span class="p">(</span><span class="s">&#34;Booting kernel&#34;</span><span class="p">,</span>
                  <span class="n">static_command_line</span><span class="p">,</span> <span class="n">__start___param</span><span class="p">,</span>
                  <span class="n">__stop___param</span> <span class="o">-</span> <span class="n">__start___param</span><span class="p">,</span>
                  <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">unknown_bootoption</span><span class="p">);</span>
    <span class="p">...</span>
    <span class="c1">//serial8250_conosole_init调用，根据命令行参数更新控制台信息
</span><span class="c1"></span>    <span class="n">console_init</span><span class="p">();</span>
    <span class="p">...</span>
</code></pre></td></tr></table>
</div>
</div><p>查看System.map文件，  <strong>__start___param</strong>  和  <strong>__stop___param</strong>  之间包含所有grub参数，查看lds文件，  <strong>__start___param</strong>  和  <strong>__stop___param</strong>  指向名为  <strong>__param</strong>  的段。
只有  <em>include/linux/moduleparam.h</em>  中用到了这个段：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"><span class="cp">#define __module_param_call(prefix, name, ops, arg, perm, level)
</span><span class="cp"></span>    <span class="cm">/* Default value instead of permissions? */</span>
    <span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__param_str_</span><span class="err">##</span><span class="n">name</span><span class="p">[]</span> <span class="o">=</span> <span class="n">prefix</span> <span class="err">#</span><span class="n">name</span><span class="p">;</span>
    <span class="k">static</span> <span class="k">struct</span> <span class="n">kernel_param</span> <span class="n">__moduleparam_const</span> <span class="n">__param_</span><span class="err">##</span><span class="n">name</span>
    <span class="n">__used</span>
    <span class="n">__attribute__</span> <span class="p">((</span><span class="n">unused</span><span class="p">,</span><span class="n">__section__</span> <span class="p">(</span><span class="s">&#34;__param&#34;</span><span class="p">),</span><span class="n">aligned</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">))))</span>
    <span class="o">=</span> <span class="p">{</span> <span class="n">__param_str_</span><span class="err">##</span><span class="n">name</span><span class="p">,</span> <span class="n">ops</span><span class="p">,</span> <span class="n">VERIFY_OCTAL_PERMISSIONS</span><span class="p">(</span><span class="n">perm</span><span class="p">),</span>
    <span class="n">level</span><span class="p">,</span> <span class="p">{</span> <span class="n">arg</span> <span class="p">}</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>所有的kernel parameters（<em>Documentation/kernel-parameters</em> )都直接或者间接通过这个宏定义，但是其中没有与“console”匹配的参数，所以 <code>parse_one</code>  函数还是会执行 <code>handle_unknown</code>  ，即 <code>unknown_bootoption</code>  -&gt; <code>obsolete_checksetup</code>  。</p>
<p>在执行 <code>obsolete_checksetup</code>  前， <code>unknown_bootoption</code>  会先调用 <code>repair_env_string</code>  , 将参数 <code>param</code>  和 <code>value</code>   拼接成 &ldquo;param=value&quot;的形式，之后将其作为参数传递给 <code>obsolete_checksetup</code>  函数。</p>
<p>在解析 <code>obsolete_checksetup</code>  函数之前，先说明  <em>include/linux/init.h</em>  中的  <strong>__setup</strong>  宏：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"><span class="cp">#define __setup(str, fn)
</span><span class="cp"></span>    <span class="n">__setup_param</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>和 <strong>early_param</strong> 宏类似,，  <strong>__setup</strong>  宏也通过  <strong>__setup_param</strong>  宏定义，只是传入的 <strong>early</strong> 参数为0。因此，  <em>kernel/printk/printk.c</em>  中的 <code>__setup(&quot;console=&quot;, console_setup);</code> ，即</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"><span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__setup__str_console_setup</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&#34;console=&#34;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">obs_kernel_param</span> <span class="n">__setup_console_setup</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">__setup_str_console_setup</span> <span class="o">=&gt;</span> <span class="s">&#34;console=&#34;</span><span class="p">,</span>
    <span class="n">console_setup</span><span class="p">,</span>
    <span class="mi">0</span>
<span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div><p>这样，在执行 <code>obsolete_checksetup</code>  函数时，</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"><span class="c1">// @line=&#34;console=ttyS0,115200n8&#34;
</span><span class="c1"></span><span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">obsolete_checksetup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">line</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="k">struct</span> <span class="n">obs_kernel_param</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">had_early_param</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="cm">/* __setup_start声明在init/main.c中，
</span><span class="cm">      根据lds文件，__setup_start指向section(.init.setup)
</span><span class="cm">      也可以根据System.map文件，查看__setup_start -
</span><span class="cm">      __setup_end 之间的所有函数.
</span><span class="cm">      这里，会遍历所有定义在section(.init.setup)中的函数 */</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">__setup_start</span><span class="p">;</span>
    <span class="k">do</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">);</span>
        <span class="cm">/* 这里，定义在kernel/printk/printk.c
</span><span class="cm">        中的 struct obs_kernel_param
</span><span class="cm">        __setup_console_setup对象的
</span><span class="cm">        str成员就能够通过检查 */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">parameqn</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span> <span class="p">{</span>    <span class="c1">//true
</span><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">early</span><span class="p">)</span> <span class="p">{</span>     <span class="c1">//false
</span><span class="c1"></span>                <span class="cm">/* Already done in parse_early_param?
</span><span class="cm">                 * (Needs exact match on param part).
</span><span class="cm">                 * Keep iterating, as we can have early
</span><span class="cm">                 * params and __setups of same names 8( */</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span> <span class="o">||</span> <span class="n">line</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;=&#39;</span><span class="p">)</span>
                    <span class="n">had_early_param</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">setup_func</span><span class="p">)</span> <span class="p">{</span>    <span class="c1">//false
</span><span class="c1"></span>                <span class="n">pr_warn</span><span class="p">(</span><span class="s">&#34;Parameter %s is obsolete, ignored</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
                    <span class="n">p</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">);</span>
                <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
            <span class="cm">/* 调用console_setup函数，将param对应的value作为参数 */</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">setup_func</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="n">n</span><span class="p">))</span>
                <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">p</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">p</span> <span class="o">&lt;</span> <span class="n">__setup_end</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">had_early_param</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>因此，接下来会调用 <code>console_setup</code>  (  <em>kernel/printk/printk.c</em>  )函数：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"><span class="cm">/* @str=&#34;ttyS0,115200n8&#34; */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">console_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">console_cmdline</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">];</span> <span class="cm">/* 4 for index */</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="o">*</span><span class="n">options</span><span class="p">,</span> <span class="o">*</span><span class="n">brl_options</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">_braille_console_setup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">str</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">brl_options</span><span class="p">))</span> <span class="c1">//false
</span><span class="c1"></span>        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

    <span class="cm">/*
</span><span class="cm">     * Decode str into name, index, options.
</span><span class="cm">     */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="sc">&#39;0&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="sc">&#39;9&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">strcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&#34;ttyS&#34;</span><span class="p">);</span>
        <span class="n">strncpy</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">-</span> <span class="mi">5</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="cm">/* sizeof(buf)=12
</span><span class="cm">           buf=&#34;ttyS0,11520&#34; */</span>
        <span class="n">strncpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">buf</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">options</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="sc">&#39;,&#39;</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="c1">//str=&#34;ttyS0&#34; &#34;115200&#34;
</span><span class="c1"></span>        <span class="o">*</span><span class="p">(</span><span class="n">options</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">s</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span> <span class="n">s</span><span class="o">++</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">s</span> <span class="o">&gt;=</span> <span class="sc">&#39;0&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">s</span> <span class="o">&lt;=</span> <span class="sc">&#39;9&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="o">*</span><span class="n">s</span> <span class="o">==</span> <span class="sc">&#39;,&#39;</span><span class="p">)</span>
            <span class="k">break</span><span class="p">;</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
    <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="cm">/* buf = ttyS, idx = 0, options = 115200n8 */</span>
    <span class="n">__add_preferred_console</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">brl_options</span><span class="p">);</span>
    <span class="n">console_set_on_cmdline</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>接下来调用 <code>__add_preferred_console</code>  函数，</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"><span class="cm">/* @name=&#34;ttyS&#34;
</span><span class="cm">   @idx=0
</span><span class="cm">   @options=&#34;115200n8&#34;
</span><span class="cm">   @brl_options=NULL  */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__add_preferred_console</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">options</span><span class="p">,</span>
                   <span class="kt">char</span> <span class="o">*</span><span class="n">brl_options</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">console_cmdline</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

    <span class="cm">/*
</span><span class="cm">     *  See if this tty is not yet registered, and
</span><span class="cm">     *  if we have a slot free.
</span><span class="cm">     */</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">console_cmdline</span><span class="p">;</span>
         <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_CMDLINECONSOLES</span> <span class="o">&amp;&amp;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
         <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">c</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
         <span class="c1">//如果console_cmdline中包含匹配的控制台，设置selected_console
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">==</span> <span class="n">idx</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">brl_options</span><span class="p">)</span>
                <span class="n">selected_console</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">MAX_CMDLINECONSOLES</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">E2BIG</span><span class="p">;</span>
    <span class="c1">//console_cmdline中没有匹配的控制台，但是有空闲的slot
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">brl_options</span><span class="p">)</span>
        <span class="n">selected_console</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">strlcpy</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
    <span class="n">c</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">=</span> <span class="n">options</span><span class="p">;</span>
    <span class="n">braille_set_options</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">brl_options</span><span class="p">);</span>

    <span class="n">c</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>console_cmdline</strong> 变量定义在  <em>kernel/printk/printk.c</em>  中的static  <strong>struct console_cmdline</strong> 对象的数组，最多包含8个元素，只有 <code>__add_preferred_console</code>  函数会对其进行修改操作。</p>
<p>因此，对于kernel param <strong>&ldquo;console=uart[8250],io/mmio,&lt;addr&gt;[,options]&quot;</strong> ，执行 <code>register_console</code>  函数时，<strong>selected_console=-1</strong>；对于 <strong>&ldquo;console=ttyS&lt;n&gt;[,options]&quot;</strong> ，执行 <code>__add_preferred_console</code>  函数时， <strong>console_cmdline</strong> 变量中没有元素，因此会把新增的控制台保存在数组中的一个元素，执行 <code>register_console</code>  时 <strong>selected_console=0</strong>  。</p>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">Globs Guo</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">
        2019-10-12
        
    </span>
  </p>
  
  
</div>
<div class="post-reward">
  <input type="checkbox" name="reward" id="reward" hidden />
  <label class="reward-button" for="reward">Reward</label>
  <div class="qr-code">
    
    <label class="qr-code-image" for="reward">
        <img class="image" src="/img/reward/wechat.jpg">
        <span>wechat</span>
      </label>
    <label class="qr-code-image" for="reward">
        <img class="image" src="/img/reward/alipay.jpg">
        <span>alipay</span>
      </label>
  </div>
</div><footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/kernel-sources/">kernel-sources</a>
          <a href="/tags/console/">console</a>
          <a href="/tags/grub/">grub</a>
          <a href="/tags/kernel-parameters/">kernel parameters</a>
          <a href="/tags/cmdline/">cmdline</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/driver_model/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">driver model</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/memory_policy/">
            <span class="next-text nav-default">Linux Memory Policy</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  
    <script src="https://utteranc.es/client.js"
            repo="GlobsGuo/utterancesRepo"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="sendtomedivh@126.com" class="iconfont icon-email" title="email"></a>
      <a href="http://github.com/globsguo" class="iconfont icon-github" title="github"></a>
  <a href="https://blog.globs.site/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv"> site pv: <span id="busuanzi_value_site_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> </span>
      <span class="division">|</span>
    <span id="busuanzi_container_site_uv"> site uv: <span id="busuanzi_value_site_uv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> </span>
  </div>

  <span class="copyright-year">
    &copy; 
    2019 - 
    2020
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Globs Guo</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
<script type="text/javascript" src="/dist/even.26188efa.min.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]},
      showProcessingMessages: false,
      messageStyle: 'none'
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"  integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>








</body>
</html>
